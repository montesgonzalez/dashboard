{% extends "layouts/base.html" %}

{% block title %}Detalle del Viaje{% endblock %}

{% block content %}
<html>
<head>
    <title>Detalle del Viaje</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #mapid { height: 400px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Mapa del viaje seleccionado -->
        <div id="mapid" class="mb-4"></div>

<!-- Detalles del viaje seleccionado -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title">Detalles del Viaje</h5>
    </div>
    <ul class="list-group list-group-flush">
        <li class="list-group-item">ID: {{ viaje.id }}</li>
        <li class="list-group-item">Conductor: {{ viaje.conductor_nombre|default:"Conductor no asignado" }}</li>
        <li class="list-group-item">Vehículo: {{ viaje.vehiculo|default:"Vehículo no asignado" }}</li>
        <li class="list-group-item">Dispositivo: {{ viaje.dispositivo|default:"Dispositivo no asignado" }}</li>
        <li class="list-group-item">Inicio: {{ viaje.start_timestamp }}</li>
        <li class="list-group-item">Fin: {{ viaje.end_timestamp }}</li>
        <li class="list-group-item">Distancia Recorrida: {{ viaje.distancia_recorrida }}</li>
        <li class="list-group-item">Eventos Reales: {{ viaje.eventos_reales }}</li>
        <li class="list-group-item">Puntuación Ecológica: {{ viaje.puntuacion_ecologica }}</li>
    </ul>
</div>
 </div>       

    <!-- Código JavaScript para mostrar el mapa y los detalles del viaje seleccionado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        var map = L.map('mapid').setView([40.416775, -3.703790], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var geojsonData = JSON.parse('{{ viaje.geojson_data | safe }}');
        L.geoJSON(geojsonData, {
            style: function(feature) {
                switch (feature.properties.event_type) {
                    case 'route': return { color: "blue", weight: 5 };
                    case 'harsh_acceleration': return { color: "green", weight: 5 };
                    case 'harsh_braking': return { color: "red", weight: 5 };
                    case 'harsh_cornering': return { color: "orange", weight: 5 };
                    default: return { color: "grey", weight: 5 };
                }
            },
            pointToLayer: function (feature, latlng) {
                switch (feature.properties.event_type) {
                    case 'route': return L.circleMarker(latlng, { radius: 8, fillColor: "blue", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    case 'harsh_acceleration': return L.circleMarker(latlng, { radius: 8, fillColor: "green", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    case 'harsh_braking': return L.circleMarker(latlng, { radius: 8, fillColor: "red", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    case 'harsh_cornering': return L.circleMarker(latlng, { radius: 8, fillColor: "orange", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    default: return L.circleMarker(latlng, { radius: 8, fillColor: "grey", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                }
            },
            onEachFeature: function (feature, layer) {
                layer.on('click', function () {
                    layer.bindPopup("Tipo de evento: " + feature.properties.event_type).openPopup();
                });
            }
        }).addTo(map);
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>
{% endblock %}